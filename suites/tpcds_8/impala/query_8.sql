
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '71843','68605','72157','30381','86853','66530',
                          '30353','66584','55150','41831','94580',
                          '40733','32301','24943','36765','45437',
                          '40382','81428','92769','48960','30082',
                          '67118','68366','21728','52157','11008',
                          '18280','56461','33588','40180','37248',
                          '39152','20803','44137','31713','93771',
                          '83344','71311','25587','73275','40297',
                          '24550','15103','37330','44785','74972',
                          '75254','97200','14259','69916','68127',
                          '12509','70270','46259','16201','28274',
                          '65223','82040','70989','42037','46248',
                          '35018','53786','56899','16880','86083',
                          '18388','41339','68344','79465','97797',
                          '20908','61787','54086','24536','93690',
                          '76976','82605','13234','81471','41039',
                          '77106','95033','22154','13717','35326',
                          '42606','44998','36116','13106','13858',
                          '21691','52594','62165','25437','78802',
                          '64080','30815','60831','81524','87421',
                          '78236','19229','62978','35450','60149',
                          '17233','70864','71397','72530','87344',
                          '11614','76993','17872','59480','28617',
                          '29406','33698','75946','99650','51206',
                          '28316','24389','98016','71174','29705',
                          '93355','77329','47864','59182','88008',
                          '28190','57788','11505','14597','44698',
                          '54620','34050','84781','27327','48830',
                          '73132','63317','60252','24273','67380',
                          '26219','29076','91387','55108','33318',
                          '53256','79114','79303','34555','93550',
                          '84666','56299','87930','97127','95338',
                          '45481','53121','10514','25199','42999',
                          '69662','17813','83400','47606','38162',
                          '36539','63739','90842','22753','72247',
                          '65107','38130','57103','11621','87969',
                          '66796','36321','72035','77668','53488',
                          '49430','10887','97691','21356','34212',
                          '45861','91293','67439','51119','97332',
                          '19546','29854','15716','37337','23718',
                          '31066','70931','56175','19655','97227',
                          '46930','36890','31353','51462','80130',
                          '29170','78245','11446','95415','53454',
                          '88583','18782','16317','55001','73152',
                          '61442','79722','72209','73902','29641',
                          '94191','96414','60802','44145','42507',
                          '71082','46425','68445','32848','23581',
                          '47610','53180','54251','11385','13844',
                          '94627','62931','78167','56521','49882',
                          '62402','54725','67758','74558','12440',
                          '77790','64583','51742','30948','47852',
                          '19390','45170','45991','48189','44390',
                          '42319','22404','71441','31649','19767',
                          '82447','52434','36985','21710','83008',
                          '81065','10963','86755','91112','72501',
                          '18470','49751','53460','23907','59045',
                          '34810','21304','67206','96386','32528',
                          '43417','30739','19057','17761','57842',
                          '97386','32896','87603','97220','36857',
                          '82538','66795','45109','75556','42190',
                          '17321','30971','95598','30433','38965',
                          '99314','51836','88281','31185','63359',
                          '11558','99869','98021','57096','92479',
                          '65210','46228','70171','11198','94614',
                          '59337','33354','97435','82010','55509',
                          '35771','91007','10957','27609','12466',
                          '71691','32112','58534','11894','21630',
                          '14040','15749','51575','80507','55606',
                          '53606','35053','78389','29229','14312',
                          '38912','56910','92987','37916','84317',
                          '74239','29480','36293','51304','98692',
                          '74622','32881','32722','73533','27700',
                          '88817','93808','55453','90765','18208',
                          '58622','53540','39514','34337','77550',
                          '51884','82103','51818','61206','25408',
                          '65174','10500','24005','38124','72256',
                          '11060','88355','36943','12844','11849',
                          '20432','37628','14253','40632','15444',
                          '11830','23215','59409','48501','36885',
                          '49642','98974','13716','27029')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


