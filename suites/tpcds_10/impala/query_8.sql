
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '67454','28844','95202','29771','61066','49303',
                          '35441','26759','87349','14268','43460',
                          '26866','18337','93332','49871','62035',
                          '13364','87291','35992','20931','16118',
                          '41808','73916','50732','12858','27314',
                          '84448','60899','24039','17822','40895',
                          '71953','87827','52671','70713','95390',
                          '36572','24581','42968','62481','92377',
                          '33898','98402','15383','42478','33355',
                          '75232','91735','34647','18983','23978',
                          '19424','12428','11244','25740','31254',
                          '52954','25470','19786','58377','11215',
                          '27580','47256','87590','31837','73943',
                          '72477','63023','99458','37890','20981',
                          '35172','49057','58217','66404','43553',
                          '27808','23753','93857','51162','35194',
                          '47294','32945','48949','11922','36287',
                          '55522','58512','61688','54006','65457',
                          '26738','74110','10810','59286','66485',
                          '37479','84195','22778','25311','16776',
                          '26189','15437','74634','62606','55346',
                          '83055','93971','14940','34453','52206',
                          '56591','29216','82575','57366','36350',
                          '83451','66697','94152','30474','25312',
                          '15680','75941','55493','93951','80579',
                          '68308','38754','56414','18680','80245',
                          '88993','38132','66079','40489','20062',
                          '22363','49418','23432','79835','51237',
                          '15488','65726','46924','43338','81012',
                          '23967','17134','49625','45473','68759',
                          '48115','84008','49103','52724','71174',
                          '79244','78565','17169','45000','71003',
                          '89977','36873','60407','22224','20176',
                          '57613','19902','80838','10994','85441',
                          '42812','19853','15827','65352','54960',
                          '29198','47944','20702','84883','59407',
                          '37583','18069','82568','68298','79462',
                          '32758','19512','48937','75025','86853',
                          '21446','95469','39975','31667','30753',
                          '31293','18719','79028','12345','27785',
                          '41070','75358','91138','71364','13825',
                          '21676','34641','70482','39383','81086',
                          '36295','63663','16572','97445','46582',
                          '88905','48242','47939','70303','84175',
                          '30446','36971','88415','72142','69803',
                          '62675','12548','81164','86028','34633',
                          '36425','52706','42845','42963','31685',
                          '15589','65563','44727','89456','67625',
                          '38313','32352','19191','38690','76170',
                          '23938','50076','80609','78740','77449',
                          '76381','35674','44442','53119','13903',
                          '90149','24372','58017','20965','23586',
                          '82763','30091','32357','58571','73966',
                          '24502','14456','34530','14510','80348',
                          '72428','91060','35267','43759','76423',
                          '90952','15515','12369','24207','56114',
                          '98581','53540','85148','77747','84635',
                          '65219','99710','26787','43344','46454',
                          '12313','22678','97537','35853','19995',
                          '86266','12205','10337','41258','84970',
                          '16712','48988','39833','32329','41989',
                          '48174','18918','90253','65334','96022',
                          '74883','49152','42140','52795','37132',
                          '80214','11828','52739','13340','39015',
                          '59136','26976','75269','55855','44390',
                          '45390','57003','60133','64800','22768',
                          '40356','38347','70203','33780','19763',
                          '15247','12439','16700','40675','42919',
                          '68596','41316','29932','74754','51182',
                          '26056','21747','49410','55113','40568',
                          '99259','99460','71719','36618','49975',
                          '30550','34910','49056','21916','66637',
                          '20730','87616','86492','65956','36156',
                          '40799','11347','96657','42836','25131',
                          '86443','58305','69114','32934','24540',
                          '48410','40133','77331','55792','66908',
                          '94149','31677','34704','95854','12311',
                          '89747','34043','22340','17681','69802',
                          '46575','55443','81149','11266','20240',
                          '19914','87822','82732','28447')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


