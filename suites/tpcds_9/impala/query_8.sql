
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '45978','34592','95431','28757','25783','77510',
                          '77897','31691','29426','20543','18345',
                          '50134','13450','52111','45192','57940',
                          '69062','92919','18620','33509','11023',
                          '58875','21147','40624','33905','43810',
                          '10071','75755','45404','38402','38114',
                          '28553','27376','34832','46556','97538',
                          '50577','40460','13621','69404','12192',
                          '13446','89670','42143','38116','79756',
                          '88818','91291','24453','86273','93128',
                          '36893','15525','18146','80072','29764',
                          '37556','80589','75403','33041','87466',
                          '20412','62128','94923','70092','97090',
                          '31500','18856','13015','54398','38095',
                          '42414','48156','53987','70198','75034',
                          '52392','96587','59782','84178','42794',
                          '16711','60662','88850','53972','79521',
                          '49064','31735','17445','22095','87211',
                          '32814','27360','12063','12534','90879',
                          '54155','69899','14553','57356','48922',
                          '79486','57546','68806','11087','26333',
                          '83065','31574','13241','16549','73122',
                          '74825','43821','83964','80699','53429',
                          '82960','35941','26848','89189','16425',
                          '99723','39899','81272','67556','33985',
                          '29620','63666','90826','66768','79960',
                          '83504','45268','46787','31815','85415',
                          '89766','58762','63278','53581','96130',
                          '49569','84408','36689','35163','61567',
                          '12259','30378','10408','50786','17161',
                          '48757','98209','39138','58388','57021',
                          '36955','84359','31911','48081','51615',
                          '62108','81377','75871','69357','52671',
                          '90935','86950','34140','33866','63388',
                          '13018','22268','84240','80597','18846',
                          '49556','62785','42079','71709','28920',
                          '56787','91371','20676','42336','33070',
                          '94848','21880','28314','35936','18709',
                          '53125','93381','25382','25765','71889',
                          '25203','26288','43167','91840','23037',
                          '23774','88424','72044','95533','14298',
                          '62332','93788','34022','47930','10959',
                          '29691','68390','49820','51430','48938',
                          '88744','92092','12311','40717','34019',
                          '52225','43476','34985','93647','57282',
                          '20890','11414','21358','27534','21219',
                          '13805','76718','74263','69208','58926',
                          '14690','68315','24444','18134','23227',
                          '60155','81474','71785','37727','38783',
                          '44513','44326','71007','23941','66235',
                          '36277','55391','21615','10566','72701',
                          '29352','99698','51987','44955','53970',
                          '19964','28082','89560','65256','10156',
                          '25963','90694','55764','34183','29219',
                          '10824','23415','61011','49597','67823',
                          '23666','83669','16612','15315','68939',
                          '22709','93340','53765','69800','38988',
                          '67592','10705','45836','43675','13638',
                          '62515','47802','72054','26730','38515',
                          '16503','89664','38666','69008','46340',
                          '27278','92964','45060','44814','64364',
                          '71037','25272','69477','29018','31514',
                          '66980','85426','10950','51309','59045',
                          '87006','31753','39200','59998','84127',
                          '93399','76316','28026','66637','21840',
                          '38404','97539','14354','16352','76474',
                          '26637','41252','11149','80447','78111',
                          '10760','90641','11713','64547','67190',
                          '67873','35008','94262','20529','39643',
                          '61492','15159','48899','79126','45430',
                          '52899','58240','30976','86903','92116',
                          '96332','35240','70261','44548','52928',
                          '64786','30960','66220','30184','33890',
                          '92430','18246','71262','82067','88376',
                          '27340','70204','49466','43160','70993',
                          '96773','74556','15107','42170','36723',
                          '29052','56766','22053','25186','57080',
                          '21733','11828','51454','15534','74183',
                          '19967','92087','15653','81383','70819',
                          '21707','60430','53639','13492')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


