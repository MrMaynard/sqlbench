
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '89360','71495','95851','36432','75465','53986',
                          '20543','63641','20439','75593','49347',
                          '20415','41053','58253','87923','11214',
                          '77106','72137','75755','64854','13102',
                          '54427','69533','48789','49712','34658',
                          '69404','90728','43513','57428','79756',
                          '82369','37426','35603','69508','14816',
                          '34934','30307','81240','32607','21970',
                          '14744','43771','58123','31970','23554',
                          '61072','72955','48804','35476','23119',
                          '22709','65136','15969','46569','62376',
                          '71451','45132','30281','75419','58098',
                          '57056','17201','36977','58572','14940',
                          '82216','84449','61134','60643','69821',
                          '16593','70403','66080','18705','81591',
                          '51517','44994','91963','65714','22061',
                          '76447','47103','44419','29620','63313',
                          '88722','66039','75935','79258','98653',
                          '67119','49737','35446','73757','24503',
                          '93003','40176','30378','31924','34641',
                          '82089','99580','12043','16710','46041',
                          '24475','52026','85063','86095','21420',
                          '12799','64810','57919','31541','49554',
                          '30832','69215','23221','82765','71561',
                          '67696','49565','45573','29883','11221',
                          '96444','20827','22390','50840','89418',
                          '54936','89872','35560','30771','10040',
                          '86877','22705','71194','57113','93041',
                          '15332','48275','98887','81462','83054',
                          '40717','55147','52832','64743','70168',
                          '16346','21774','48268','12546','90398',
                          '20774','39620','82490','72169','87848',
                          '79743','57585','39834','41429','76446',
                          '22117','12999','30330','48166','24652',
                          '89713','69494','23397','94172','25759',
                          '25654','10955','97389','72334','80082',
                          '48583','37045','56521','54542','10624',
                          '56389','19700','50092','86286','10706',
                          '71888','93470','94903','24273','31669',
                          '61431','71706','94189','60325','66877',
                          '58546','64674','74142','87918','54780',
                          '40491','32762','20195','71992','52240',
                          '43907','18342','26084','10574','12758',
                          '66637','85675','39911','43751','55776',
                          '40268','10677','32175','10760','97341',
                          '39944','74572','72312','27055','38125',
                          '88281','89624','93905','45237','34838',
                          '86903','89928','17512','75674','22546',
                          '73437','63837','80449','28485','15882',
                          '82067','84990','48554','43046','44223',
                          '46738','20043','28976','39691','81801',
                          '96631','77545','26501','89850','37927',
                          '76063','25495','67405','52987','19053',
                          '40678','82038','45402','64460','48697',
                          '16478','77907','45623','14797','62917',
                          '75301','81637','51410','13330','58210',
                          '18473','59069','11826','58408','85699',
                          '27682','40328','73177','32548','31872',
                          '66538','98733','79252','41531','97643',
                          '60795','90992','19645','55042','70076',
                          '22200','63193','61256','29827','31724',
                          '78574','59953','80520','97386','22192',
                          '95858','61636','17590','95422','96104',
                          '23350','83751','99975','43065','94327',
                          '93482','48214','22848','92321','21632',
                          '50309','66242','11675','74235','29976',
                          '18534','46849','96531','31086','29907',
                          '29878','28160','79357','13317','75364',
                          '58515','90095','99437','48055','49194',
                          '67396','41322','68991','40668','65738',
                          '59744','30641','17488','61890','30509',
                          '25830','36335','46432','35150','74791',
                          '46613','82558','68918','25574','30481',
                          '16878','27982','78724','12450','62251',
                          '17325','76082','25948','68761','26167',
                          '67849','30708','33186','36205','77604',
                          '28474','86961','53856','14757','11387',
                          '20932','41219','22961','98886','80611',
                          '51372','94217','92057','24340','58061',
                          '38712','58334','33699','68581')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


